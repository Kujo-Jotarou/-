<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CYBER BLITZ : HACKER BEATS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
  <style>
    html,body {
      background: radial-gradient(ellipse at 50% 47%, #0a1220 70%, #090f18 100%);
      overflow: hidden; height:100vh;
      margin:0; padding:0;
      color:#0fffc0;
      font-family: 'Orbitron', monospace;
    }
    #bg-anim {
      position:fixed; width:100vw; height:100vh; left:0; top:0; z-index:0; pointer-events:none;
      background: repeating-linear-gradient(270deg,#0fffc066 0 2px,#7b40ff 2px 4px,transparent 4px 18px),
                  linear-gradient(120deg,#0fffc033 50%,#7b40ff0c 100%);
      animation: bganim 13s linear infinite alternate;
      opacity:0.97;
      mix-blend-mode: lighten;
    }
    @keyframes bganim {
      0% {background-position:0 0,0 0;}
      100% {background-position:270px 360px,90px 170px;}
    }
    #logo {
      font-family:'Orbitron',monospace;
      font-size:5vw; font-weight:900;
      letter-spacing:0.19em;
      padding-top:7vh; text-align:center;
      color: #0fffc0;
      filter: drop-shadow(0 0 19px #7b40ffcc) drop-shadow(0 0 44px #0fffc099);
      text-shadow:
        0 0 18px #0fffc0,
        0 0 37px #7b40ff,
        0 0 1px #111;
      user-select:none;
    }
    #logo .glitch {
      display:inline-block;
      animation:glitch 2.2s infinite cubic-bezier(.18,.7,.52,1);
      position:relative;
    }
    @keyframes glitch {
      0% {transform:translate(0,0);}
      12% {transform:translate(-3px,2px) skewX(-10deg);}
      23% {transform:translate(2px,-2px) skewX(8deg);}
      35% {transform:translate(-6px,2px) skewX(-13deg);}
      47% {transform:translate(3px,0) skewX(12deg);}
      59% {transform:translate(0,0);}
      80% {transform:translate(1px,-2px) skewX(10deg);}
      100% {transform:translate(0,0);}
    }
    #subtitle {
      font-size:1.3em; letter-spacing:0.15em;
      color:#f0ffae; text-align:center; margin-top:6px;
      filter:drop-shadow(0 0 12px #7b40ff99);
      opacity:0.95;
    }
    .mainbox {
      background: linear-gradient(120deg,#232349e0 55%,#181c42c0 100%);
      margin:2vw auto 0 auto; max-width:570px; border-radius:21px; box-shadow:0 0 48px #0fffc099,0 0 1px #333;
      padding:33px 24px 22px 24px;
      text-align:center; position:relative; z-index:1;
      border:2.5px solid #0fffc055;
    }
    .mainbtn, .btn {
      background: linear-gradient(90deg, #0fffc0 20%, #7b40ff 80%);
      color: #101022; border: none; border-radius: 14px;
      font-family: inherit; font-weight: bold; font-size: 1.32em;
      padding: 12px 27px; cursor: pointer; box-shadow: 0 0 8px #7b40ff80;
      margin: 28px 4px 18px 4px; transition: 0.14s;
      letter-spacing:0.08em;
      filter:drop-shadow(0 0 14px #0fffc0cc);
      text-shadow:0 0 4px #fff;
    }
    .mainbtn:hover, .btn:hover { filter: brightness(1.14) drop-shadow(0 0 18px #f0ffaecc);}
    .desc {
      margin:19px 0 13px 0; font-size:1.09em; color:#f0ffaecc; text-align:center;
      filter:drop-shadow(0 0 5px #333);
    }
    #wave {
      width:100%; height:65px; margin:0 auto 4px auto; display:block;
      background:transparent;
      filter: blur(0.7px) drop-shadow(0 0 18px #0fffc0aa);
      pointer-events:none;
    }
    .meta {
      margin:18px 0 0 0; font-size:1.03em; color:#7b40ffcc; letter-spacing:0.09em;
      font-family:'Orbitron',monospace;
      text-align:center;
    }
    #gameWrap {
      display:none;
      width:100vw; height:100vh;
      position:fixed; left:0; top:0; z-index:5;
      background: radial-gradient(ellipse at 50% 50%, #0a1220 60%, #090f18 100%);
      animation:fadein .9s;
    }
    @keyframes fadein {0%{opacity:0;} 100%{opacity:1;}}
    #gameCanvas {
      display: block; margin: 4vh auto 0 auto; background: linear-gradient(180deg, #1a1c29 0%, #222c44 100%);
      border-radius: 20px; box-shadow: 0 0 30px #0fffc066;
      border: 2.5px solid #0fffc044;
      transition: box-shadow 0.2s;
      position: relative; z-index: 1;
    }
    #scorebar {
      font-size: 1.2em; margin: 12px 0 0 0; text-align: center;
      text-shadow: 0 0 8px #0fffc0;
      color:#f0ffae;
    }
    #judgelabel {
      font-size:1.8em;margin-top:6px;text-align:center;
      text-shadow: 0 0 20px #fff,0 0 6px #0fffc0;
      height:2.2em;
    }
    .modeselect { display:flex; justify-content:center; gap:1.3em; margin-top:16px;}
    .modeselect .btn {font-size:1.11em;}
    #chartCanvas { width:95vw; max-width:820px; height:76px; margin:10px auto; display:block;}
    #resultWrap {
      display:none; position:fixed; top:0;left:0;width:100vw;height:100vh;
      background:rgba(8,12,28,0.95); z-index:10;
      text-align:center; animation:fadein .7s;
    }
    #resultbox {
      display:inline-block; background:linear-gradient(120deg,#212345 60%,#2c2850a0 100%);
      margin:14vh auto 0 auto; border-radius:22px; box-shadow:0 0 54px #0fffc099;
      padding:38px 29px 24px 29px; border:2.5px solid #0fffc055;
      min-width:340px;
    }
    #resultScore {
      font-size:2.6em;font-family:'Orbitron',monospace;color:#0fffc0;
      text-shadow:0 0 13px #7b40ff99,0 0 30px #0fffc055;
      letter-spacing:0.13em;
    }
    #rank { font-size:3.7em; color:#f0ffae; font-family:'Orbitron',monospace;text-shadow:0 0 20px #fff,0 0 8px #0fffc0;}
    #resultMeta {margin-top:1.5em; color:#aaa; font-size:1.05em;}
    #sharebtn {
      background:#222;color:#0fffc0;font-size:1.17em;border-radius:8px;padding:8px 26px;margin-top:23px;letter-spacing:0.07em;
      border:2px solid #7b40ff80;transition:0.11s;
    }
    #sharebtn:hover {filter:brightness(1.13);}
    @media (max-width:600px) {
      #logo {font-size:9vw;}
      .mainbox {padding:13px 3vw 12px 3vw;}
      .mainbtn {font-size:1em; padding:7px 13vw;}
      #resultbox{padding:16px 3vw 16px 3vw;}
    }
  </style>
</head>
<body>
  <div id="bg-anim"></div>
  <div id="logo">
    <span class="glitch">CYBER</span> <span style="color:#7b40ff;">BLITZ</span>
  </div>
  <div id="subtitle">
    HACKER BEATS<br>
    <span style="font-size:0.81em;color:#aaa">― 電脳をブチ抜く音ゲー × 爆光サイバーパンクの極地 ―</span>
  </div>
  <div class="mainbox" id="topUI">
    <div class="desc">
      <b>MP3アップロードで<br>譜面自動生成＆爆光・グリッチ・脳汁サイバー音ゲー！</b>
    </div>
    <input type="file" id="mp3input" accept=".mp3,audio/*" style="margin:13px auto 3px auto;display:block;">
    <div class="modeselect">
      <button class="btn" onclick="setMode('normal')">NORMAL譜面</button>
      <button class="btn" onclick="setMode('hard')">HARD譜面</button>
      <button class="btn" onclick="setMode('random')">RANDOM譜面</button>
    </div>
    <div id="chartPreview"><canvas id="chartCanvas" width="800" height="70"></canvas></div>
    <div id="wave"></div>
    <div class="meta">
      <span>音ゲー × サイバー × ハック</span><br>
      <span style="font-size:0.8em;">© 2024 CyberBlitz Project</span>
    </div>
  </div>
  <div id="gameWrap">
    <div id="scorebar">SCORE 0 | COMBO 0 | MAX 0 | MISS 0</div>
    <canvas id="gameCanvas" width="1150" height="590"></canvas>
    <div id="judgelabel"></div>
    <button class="btn" onclick="location.reload()" style="margin:17px auto 7px auto;display:block;">別の曲で遊ぶ</button>
  </div>
  <div id="resultWrap">
    <div id="resultbox">
      <div id="rank"></div>
      <div id="resultScore"></div>
      <div id="resultMeta"></div>
      <button id="sharebtn" onclick="tweetScore()">Xでシェア</button>
      <button class="btn" onclick="location.reload()" style="margin-left:22px;">TOPへ</button>
    </div>
  </div>
  <script>
    // ---- サイバー波形演出
    const wave = document.createElement('canvas');
    wave.width=560; wave.height=60;
    document.getElementById('wave').appendChild(wave);
    const wctx = wave.getContext('2d');
    function drawWave(t){
      wctx.clearRect(0,0,wave.width,wave.height);
      for(let i=0;i<wave.width;i+=3){
        let y = Math.sin((i/47)+t*2.2)*21+Math.cos((i/34)+t*1.6)*10 + 30;
        wctx.beginPath();
        wctx.arc(i,y,5+2*Math.sin(i/24+t*7),0,2*Math.PI);
        wctx.fillStyle=`hsl(${(i+t*290)%360},100%,56%)`;
        wctx.globalAlpha=0.52+0.32*Math.sin(i/24+t*8);
        wctx.fill();
      }
      wctx.globalAlpha=1.0;
    }
    function loop(){drawWave(performance.now()/370); requestAnimationFrame(loop);}
    loop();

    // ---- ゲームロジック
    let noteMode = "normal";
    function setMode(mode){noteMode=mode; showChartPreview();}
    // BPM推定
    async function estimateBPM(audioBuffer){
      let data = audioBuffer.getChannelData(0);
      let len = data.length, step = Math.floor(audioBuffer.sampleRate*0.011);
      let peaks=[], last=-1;
      for(let i=0;i<len;i+=step){
        if(Math.abs(data[i])>0.32 && i-last>audioBuffer.sampleRate*0.16){
          peaks.push(i/audioBuffer.sampleRate); last=i;
        }
      }
      let intervals=[]; for(let i=1;i<peaks.length;i++) intervals.push(peaks[i]-peaks[i-1]);
      let avg = intervals.reduce((a,b)=>a+b,0)/intervals.length||0.5;
      let estbpm = Math.round(60/avg)||120;
      return Math.min(210,Math.max(62,estbpm));
    }

    // 本格自動譜面生成
    function autoGenerateNotes(audioBuffer, bpm, duration, laneCount, mode="normal") {
      const data = audioBuffer.getChannelData(0);
      const sampleRate = audioBuffer.sampleRate;
      const windowSize = Math.floor(sampleRate * 0.021); // 21ms
      let notes = [];
      let last = Array(laneCount).fill(-9999);
      let minInterval = mode=="hard" ? [0.10,0.10,0.10,0.07,0.07,0.10,0.10,0.10]
                                     : mode=="random"? [0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06]
                                     : [0.18,0.13,0.13,0.10,0.10,0.13,0.13,0.18];
      let th0 = mode=="hard"? 1.09 : 1.51;
      let th1 = mode=="hard"? 0.65 : 1.07;
      let th2 = mode=="hard"? 0.47 : 0.68;

      for (let i = 0; i < data.length - windowSize; i += windowSize) {
        let sum = [0,0,0];
        for (let j = 0; j < windowSize; j++) {
          let t = Math.abs(data[i + j]);
          let f = j / windowSize * sampleRate / 2;
          if (f < 180) sum[0] += t;
          else if (f < 1400) sum[1] += t;
          else sum[2] += t;
        }
        let tsec = i / sampleRate;
        if (sum[0] > th0 && tsec - last[2] > minInterval[2]) { notes.push({ time: tsec, lane: 2 }); last[2] = tsec; }
        if (sum[1] > th1 && tsec - last[5] > minInterval[5]) { notes.push({ time: tsec, lane: 5 }); last[5] = tsec; }
        if (sum[2] > th2 && tsec - last[0] > minInterval[0]) { notes.push({ time: tsec, lane: 0 }); last[0] = tsec; }
        if (mode!=="normal" && sum[2] > th2+0.14 && sum[1] > th1+0.09 && tsec - last[7] > minInterval[7]) {
          notes.push({ time: tsec, lane: 7 }); last[7] = tsec;
        }
      }
      notes = notes.filter((v, i, a) => i === 0 || v.time - a[i - 1].time > 0.06);
      notes.forEach((n,i) => { 
        if (mode=="random" || (mode=="hard"&&Math.random()<0.22) || (mode=="normal"&&Math.random()<0.11))
          n.lane = Math.floor(Math.random()*laneCount);
      });
      notes.sort((a,b)=>a.time-b.time);
      if(mode=="hard"){
        for(let i=6;i<notes.length-1;i+=5){
          if(Math.random()<0.33){
            notes.splice(i,0,{time:notes[i].time, lane:(notes[i].lane+1)%laneCount});
          }
        }
      }
      return notes.map(n=>({...n, judged:false}));
    }

    // --- ゲーム状態
    let audioCtx, source, mp3Buf, mp3Duration=60, bpm=120, songStart=0;
    let notes=[], hit=[], combo=0, maxCombo=0, score=0, miss=0, started=false, ended=false;
    let canvas, ctx, noteSpeed=255, laneCount=8, laneW, lanePad=7;
    let judgeWindow={perfect:0.11,great:0.19,good:0.32};
    let keyCustom = ['A','S','D','F','J','K','L',';'];
    let pressed = Array(laneCount).fill(false);

    // -- 曲アップロード
    document.getElementById('mp3input').addEventListener('change',async function(e){
      let file = e.target.files[0];
      if(!file) return;
      document.getElementById('topUI').style.display='none';
      document.getElementById('gameWrap').style.display='block';
      let abuf = await file.arrayBuffer();
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      mp3Buf = await audioCtx.decodeAudioData(abuf);
      mp3Duration = mp3Buf.duration;
      bpm = await estimateBPM(mp3Buf);
      notes = autoGenerateNotes(mp3Buf, bpm, mp3Duration, laneCount, noteMode);
      hit = Array(notes.length).fill(false);
      laneW = 1150/laneCount;
      combo=maxCombo=score=miss=0; pressed = Array(laneCount).fill(false);
      canvas=document.getElementById('gameCanvas'); ctx=canvas.getContext('2d');
      startGame();
    });

    // --- 譜面プレビュー
    function showChartPreview(){
      let c = document.getElementById('chartCanvas');
      let ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      if(!mp3Buf) return;
      let previewNotes = autoGenerateNotes(mp3Buf, bpm, mp3Duration, laneCount, noteMode);
      let total = Math.max(...previewNotes.map(n=>n.time),0);
      let bin = Math.ceil(total/18);
      let bins = Array(18).fill(0);
      previewNotes.forEach(n=>{
        let idx=Math.floor(n.time/bin);
        bins[idx]++;
      });
      for(let i=0;i<18;i++){
        ctx.fillStyle="#7b40ff44";
        ctx.fillRect(i*c.width/18,0,c.width/18,60);
        ctx.fillStyle="#0fffc0cc";
        ctx.fillRect(i*c.width/18,66-bins[i]*2.2, c.width/18, bins[i]*2.2);
      }
      ctx.save();
      for(let i=0;i<previewNotes.length;i++){
        ctx.fillStyle="#f0ffae";
        ctx.globalAlpha=0.75;
        let x=(previewNotes[i].time/total)*c.width;
        ctx.fillRect(x,13+previewNotes[i].lane*5,2,10);
      }
      ctx.restore();
      ctx.font="1em Orbitron"; ctx.fillStyle="#fff"; ctx.globalAlpha=0.34;
      ctx.fillText("ノーツ分布プレビュー",c.width-135,18);
    }

    // -- ゲーム開始・音再生
    function startGame(){
      source = audioCtx.createBufferSource();
      source.buffer = mp3Buf;
      source.connect(audioCtx.destination);
      source.start(0);
      songStart = audioCtx.currentTime;
      started=true; ended=false;
      requestAnimationFrame(gameLoop);
    }

    // -- キー入力＋エフェクト
    window.addEventListener('keydown',e=>{
      if(!started||ended) return;
      let k = e.key.toUpperCase();
      let lane = keyCustom.indexOf(k);
      if(lane<0) return;
      if(!pressed[lane]) pressed[lane]=true;
      let now = audioCtx.currentTime-songStart;
      let hitIdx = -1, hitDelta=999;
      for(let i=0;i<notes.length;i++){
        if(hit[i]) continue;
        let dt = Math.abs(notes[i].time-now);
        if(notes[i].lane==lane && dt<judgeWindow.good && Math.abs(dt)<hitDelta){
          hitIdx = i; hitDelta=Math.abs(dt);
        }
      }
      if(hitIdx<0) { showJudge('MISS','#ff0080'); combo=0; miss++; updateScore(); flash(0.09, "#ff008077", 1.10); playSE('miss'); return;}
      let dt = Math.abs(notes[hitIdx].time-now);
      if(dt<judgeWindow.perfect) { score+=1200; showJudge('PERFECT','#0fffc0'); combo++; flash(0.14, "#0fffc0ee", 1.18, lane); sparkWave(lane, "#0fffc0", 1.6); playSE('perfect');}
      else if(dt<judgeWindow.great) { score+=700; showJudge('GREAT','#7b40ff'); combo++; flash(0.07, "#7b40ffcc", 1.11, lane); sparkWave(lane, "#7b40ff", 1.32); playSE('great');}
      else { score+=290; showJudge('GOOD','#fff'); combo++; sparkWave(lane, "#fff", 1.02); playSE('good');}
      hit[hitIdx]=true;
      maxCombo=Math.max(combo,maxCombo);
      updateScore();
    });
    window.addEventListener('keyup',e=>{
      let k = e.key.toUpperCase();
      let lane = keyCustom.indexOf(k);
      if(lane>=0) pressed[lane]=false;
    });

    // -- エフェクト
    let flashTime=0, flashColor="#0fffc088", flashAmp=1.05;
    function flash(t,c,amp=1.07, lane=-1){
      flashTime=t; flashColor=c; flashAmp=amp; flashLane=lane;
    }
    let flashLane=-1, waveArr=[];
    function sparkWave(lane,color,amp){
      let x=lane*laneW+laneW/2, y=canvas.height-56;
      waveArr.push({x:x, y:y, color:color, r:23, t:0, amp:amp});
    }

    // -- 判定・スコア
    function showJudge(txt,col){
      document.getElementById('judgelabel').innerHTML=`<span style="color:${col}">${txt}</span>`;
      setTimeout(()=>{document.getElementById('judgelabel').innerHTML='';},390);
    }
    function updateScore(){
      document.getElementById('scorebar').innerHTML = `SCORE ${score} | COMBO ${combo} | MAX ${maxCombo} | MISS ${miss}`;
      if(combo>0 && combo%20==0) flash(0.18, "#f0ffae99", 1.19);
    }

    // -- 判定音SE
    let audioSE = {};
    function playSE(type){
      if(!audioSE[type]){
        let ctx = new (window.AudioContext||window.webkitAudioContext)();
        let o=ctx.createOscillator(),g=ctx.createGain();
        o.connect(g); g.connect(ctx.destination); g.gain.value=0.13;
        if(type=='perfect') o.frequency.value=1199;
        else if(type=='great') o.frequency.value=677;
        else if(type=='good') o.frequency.value=420;
        else o.frequency.value=180;
        o.type='triangle'; o.start();
        g.gain.linearRampToValueAtTime(0.01, ctx.currentTime+0.23);
        o.stop(ctx.currentTime+0.23);
        audioSE[type]=true;
        setTimeout(()=>{ctx.close();audioSE[type]=null},300);
      }
    }

    // -- メインゲームループ
    function gameLoop(){
      if(!started) return;
      let now = audioCtx.currentTime-songStart;
      ctx.save();
      // 背景グリッチ・波形
      ctx.globalAlpha=0.20+0.13*Math.sin(Date.now()/230);
      ctx.fillStyle='#0fffc055';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.restore();

      // レーン背景・サイバー色
      for(let l=0;l<laneCount;l++){
        ctx.fillStyle = l%2==0 ? '#282e47cc' : '#191c24bb';
        ctx.fillRect(l*laneW+lanePad,0,laneW-lanePad*2,canvas.height);
      }
      for(let l=1;l<laneCount;l++){
        ctx.strokeStyle='#0fffc044';
        ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(l*laneW,0); ctx.lineTo(l*laneW,canvas.height); ctx.stroke();
      }

      // キー押下エフェクト
      for(let l=0;l<laneCount;l++){
        if(pressed[l]){
          let y0 = canvas.height-56;
          ctx.save();
          ctx.globalAlpha=0.37+0.13*Math.sin(Date.now()/49+l*9);
          ctx.fillStyle="#0fffc033";
          ctx.fillRect(l*laneW+laneW/3,0,laneW/3,canvas.height);
          ctx.restore();
          ctx.save();
          ctx.shadowColor="#0fffc0";
          ctx.shadowBlur=43+22*Math.sin(Date.now()/107+l*19);
          ctx.globalAlpha=0.53;
          ctx.fillStyle="#7b40ffaa";
          ctx.beginPath();
          ctx.arc(l*laneW+laneW/2, y0, 40+18*Math.sin(Date.now()/77+l*19), 0, 2 * Math.PI);
          ctx.fill();
          ctx.restore();
          ctx.save();
          ctx.globalAlpha = 0.18+0.09*Math.sin(Date.now()/51+l*7);
          ctx.strokeStyle = "#f0ffae";
          ctx.lineWidth = 3.3;
          ctx.beginPath();
          ctx.arc(l*laneW+laneW/2, y0, 54+12*Math.sin(Date.now()/43+l*15), 0, 2*Math.PI);
          ctx.stroke();
          ctx.restore();
        }
      }
      // ノーツ
      let hitLineY = canvas.height-56;
      for(let i=0;i<notes.length;i++){
        let note = notes[i];
        if(hit[i]) continue;
        let d = note.time-now;
        let y = hitLineY - d*noteSpeed;
        if(y>canvas.height+40) continue;
        if(y<hitLineY-330) continue;
        if(!hit[i] && d<-judgeWindow.good){
          hit[i]=true; miss++; combo=0; updateScore();
          showJudge('MISS','#ff0080'); flash(0.07, "#ff008088", 1.06, note.lane); playSE('miss');
          continue;
        }
        ctx.save();
        ctx.beginPath();
        ctx.arc(note.lane*laneW+laneW/2, y, 21, 0, 2 * Math.PI);
        ctx.shadowColor = "#0fffc0";
        ctx.shadowBlur = 15;
        ctx.globalAlpha=0.98;
        ctx.fillStyle = "#7b40ffcc";
        ctx.fill();
        ctx.restore();
        ctx.save();
        ctx.beginPath();
        ctx.arc(note.lane*laneW+laneW/2, y, 21, 0, 2 * Math.PI);
        ctx.lineWidth=2.5;
        ctx.strokeStyle="#0fffc0cc";
        ctx.shadowColor = "#0fffc0";
        ctx.shadowBlur = 12;
        ctx.stroke();
        ctx.restore();
      }
      // 判定ライン
      ctx.save();
      ctx.globalAlpha=0.7;
      ctx.fillStyle="#0fffc044";
      ctx.fillRect(0,hitLineY-5,canvas.width,10);
      ctx.restore();
      // キーラベル
      for(let l=0;l<laneCount;l++){
        ctx.save();
        ctx.font="bold 1.4em Orbitron";
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.shadowColor=pressed[l]?"#0fffc0":"#7b40ff";
        ctx.shadowBlur=pressed[l]?19:10;
        ctx.globalAlpha=1.0;
        ctx.fillStyle=pressed[l]?"#f0ffae":"#0fffc0";
        ctx.fillText(keyCustom[l], l*laneW+laneW/2, hitLineY+36);
        ctx.restore();
      }
      // ノーツヒット波紋
      for(let i=0;i<waveArr.length;i++){
        let w = waveArr[i];
        ctx.save();
        ctx.globalAlpha=Math.max(0,1-w.t/0.38)*0.36;
        ctx.strokeStyle = w.color;
        ctx.lineWidth = 4.8+10*w.t;
        ctx.beginPath();
        ctx.arc(w.x, w.y, w.r+155*w.t, 0, 2*Math.PI);
        ctx.stroke();
        ctx.restore();
        ctx.save();
        ctx.globalAlpha=Math.max(0,1-w.t/0.30)*0.17;
        ctx.fillStyle=w.color;
        for(let k=0;k<8;k++){
          let ang=Math.PI*2*k/8+Date.now()/410;
          ctx.beginPath();
          ctx.arc(w.x+Math.cos(ang)*(w.r+50*w.t), w.y+Math.sin(ang)*(w.r+50*w.t), 7+8*w.t, 0, 2*Math.PI);
          ctx.fill();
        }
        ctx.restore();
        w.t+=1/60;
        if(w.t>0.42) { waveArr.splice(i,1); i--;}
      }
      // 全画面エフェクト
      if(flashTime>0){
        ctx.save();
        ctx.globalAlpha = Math.min(flashTime*3.2,1.0);
        ctx.fillStyle = flashColor;
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.restore();
        flashTime -= 1/60;
      }
      if(now>mp3Duration+0.35){
        ended=true; started=false;
        showResult();
      } else {
        requestAnimationFrame(gameLoop);
      }
    }

    // --- リザルト画面
    function showResult(){
      document.getElementById('resultWrap').style.display='block';
      let r = getRank(score,miss,combo,maxCombo);
      document.getElementById('rank').innerText=r;
      document.getElementById('resultScore').innerHTML=`SCORE <b>${score}</b>`;
      let txt = `最大COMBO: <b>${maxCombo}</b>　MISS: <b>${miss}</b><br>判定：PERFECT多 or 連打王？<br><br>おつかれさま！`;
      document.getElementById('resultMeta').innerHTML=txt;
    }
    function getRank(score,miss,combo,maxCombo){
      if(miss<2&&combo==maxCombo) return "SSS";
      if(score>140000) return "SS";
      if(score>70000) return "S";
      if(score>30000) return "A";
      if(score>17000) return "B";
      return "C";
    }
    function tweetScore(){
      let txt=`CYBER BLITZで遊んだ！SCORE:${score}　MAX COMBO:${maxCombo} #CyberBlitz音ゲー\n`;
      let url=location.href;
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(txt)}&url=${encodeURIComponent(url)}`,"_blank");
    }
  </script>
</body>
</html>
